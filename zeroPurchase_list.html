<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <title>限时零元购列表</title>
    <script src="./js/wordauto.js"></script>
    <link rel="stylesheet" href="./css/timePruchase.css">
    <script src="js/jquery1.11.3.js"></script>
</head>

<body>
    <div class="zero_container">
        <input type="hidden" value="0" id="user_integral">
        <header class="zero_container">
            <div class="zero_header_imgBox">
                <img src="./images/zeroPurchase/header2.png" alt="header">
            </div>
            <div class="zero_listM_countDown" id="listM_countDonw">
                距结束仅剩
                <div>00</div>
                <div>01</div>
                <div>02</div>
            </div>
        </header>
        <div class="zero_container">
            <ul class="zero_list">
                <li>
                    <div class="zero_list_title">
                        正大雨幕洒洒的环境萨克的话
                        <span>7.9抵券</span>
                    </div>
                    <div class="zero_list_main">
                        <div class="zero_listM_imgBox">
                            <img src="./images/zeroPurchase/product.jpg" alt="product">
                        </div>
                        <div class="zero_listM_content">

                            <div class="zero_listM_detial">
                                <span>净含量:23gX5个</span>
                                <span>剩余50份</span>
                            </div>
                            <div class="zero_listM_validity">
                                优惠券有效期至2018年12月12日
                            </div>
                            <div class="zero_listM_number">
                                <span>门店家:10.00</span>
                                <span>100
                                    <span>积分</span>
                                </span>
                            </div>
                            <div class="zero_listM_confrim">
                                <a href="###" onclick="compareIntegral(this,'user_integral','alert_confrim','alert_error'
                                ,['100','正大玉米蔬菜猪肉蒸饺十份','净含量23gx5个','2018-12-11','id'],'alert_serverError')">立即秒杀</a>
                            </div>
                            <input type="hidden" value="100" class="product_integral">
                        </div>
                    </div>
                </li>
                <li>
                    <div class="zero_list_title">
                        正大雨幕洒洒的环境萨克的话
                    </div>
                    <div class="zero_list_main">
                        <div class="zero_listM_imgBox">
                            <img src="./images/zeroPurchase/product.jpg" alt="product">
                        </div>
                        <div class="zero_listM_content">

                            <div class="zero_listM_detial">
                                <span>净含量:23gX5个</span>
                                <span>剩余50份</span>
                            </div>
                            <div class="zero_listM_validity">
                                优惠券有效期至2018年12月12日
                            </div>
                            <div class="zero_listM_number">
                                <span>门店家:10.00</span>
                                <span>100积分</span>
                            </div>
                            <div class="zero_listM_confrim">
                                <a href="###" onclick="compareIntegral(this,'user_integral','alert_confrim','alert_error')">立即秒杀</a>
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="zero_list_title">
                        正大雨幕洒洒的环境萨克的话
                    </div>
                    <div class="zero_list_main">
                        <div class="zero_listM_imgBox">
                            <img src="./images/zeroPurchase/product.jpg" alt="product">
                        </div>
                        <div class="zero_listM_content">

                            <div class="zero_listM_detial">
                                <span>净含量:23gX5个</span>
                                <span>剩余50份</span>
                            </div>
                            <div class="zero_listM_validity">
                                优惠券有效期至2018年12月12日
                            </div>
                            <div class="zero_listM_number">
                                <span>门店家:10.00</span>
                                <span>100
                                    <span>积分</span>
                                </span>
                            </div>
                            <div class="zero_listM_confrim">
                                <a href="###">立即秒杀</a>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
            <!-- 弹出层 -->
            <div class="zero_list_alert" id="alert_confrim">
                <div class="zero_listA_box">
                    <p class="zero_listA_title">确认使用100积分兑换</p>
                    <p class="zero_listA_title">正大玉米蔬菜猪肉蒸饺一份</p>
                    <p class="zero_listA_word">净含量23gx5个</p>
                    <p class="zero_listA_word">优惠券需在全联超商门店使用</p>
                    <p class="zero_listA_word">优惠券有效期至2018年12月12日</p>
                    <p class="zero_listA_confrim">
                        <a href="###">确认</a>
                    </p>
                </div>
            </div>
            <div class="zero_list_alert" id="alert_error">
                <div class="zero_listA_box">
                    <p class="zero_listA_errorImg">
                        <img src="./images/zeroPurchase/sorry.png" alt="sorry">
                    </p>
                    <p class="zero_listA_errorWord">
                        您的积分额度不足
                    </p>
                    <p class="zero_listA_errorWord">
                        未能获取优惠券
                    </p>
                </div>
            </div>
            <div class="zero_list_alert" id="alert_serverError">
                <div class="zero_listA_box">
                    <p class="zero_listA_errorImg">
                        <img src="./images/zeroPurchase/sorry.png" alt="sorry">
                    </p>
                    <p class="zero_listA_errorWord">
                        错误信息
                    </p>
                </div>
            </div>
            <!-- 用户列表按钮-->
            <div class="zero_userlist">
                <a href="###"></a>
            </div>
        </div>
    </div>
    <script src="./js/zero_countDown.js"></script>
    <script>
        invokingTime("listM_countDonw", "2018-07-04 14:59:50");
    </script>
    <script>
        /* 别问我为什么这么写 我只是想恶心恶心自己 2018/7/5 */
        // 判断 用户积分  与积分对比 来决定弹出乃个对话框
        function compareIntegral(_this, _user, _confrim, _error, _confrimText, _serverError) {
            var defaultOption = {
                userIntegral: 1000,
                productIntegral: 100,
                confrimId: "alert_confrim",
                errorId: "alert_error",
                comfirmText: ['100', '正大玉米蔬菜猪肉蒸饺一份', '净含量23gx5个', '2018-12-12', "id"],
                serverErrorId: "alert_serverError"
            }
            var finallyOption = optionInit(defaultOption, _this, _user, _confrim, _error, _confrimText, _serverError);
            judgeIntegral(finallyOption)

            // 初始化
            function optionInit(_defaultOption, _this, _user, _confrim, _error, _confrimText, _serverError) {
                let usIntegral = parseInt($(`#${_user}`).val());
                let proIntegral = parseInt($(_this).parent().parent().find(".product_integral").val());
                let userOption = {
                    userIntegral: usIntegral,
                    productIntegral: proIntegral,
                    confrimId: _confrim || "alert_confrim",
                    errorId: _error || "alert_error",
                    comfirmText: _confrimText || ['100', '正大玉米蔬菜猪肉蒸饺一份', '净含量23gx5个', '2018-12-12',
                        "id"
                    ],
                    serverErrorId: _serverError,
                }
                return $.extend({}, _defaultOption, userOption);
            }
            //判断分数
            function judgeIntegral(_finallyOption) {
                console.log(_finallyOption.userIntegral - _finallyOption.productIntegral);
                
                if (_finallyOption.userIntegral - _finallyOption.productIntegral < 0) {
                    errorDo(_finallyOption); 
                } else {
                    trueDo(_finallyOption);
                }
            }
            //错误执行
            function errorDo(_finallyOption) {
                $(`#${_finallyOption.errorId}`).fadeIn(500);
                $(`#${_finallyOption.errorId}`).click(function () {
                    $(this).fadeOut(500);
                })
            }
            //正确执行
            function trueDo(_finallyOption) {
                let $ob = $(`#${_finallyOption.confrimId}`);
                let confrimText = _finallyOption.comfirmText;
                let $obli = $ob.find("p");
                $ob.children("div").click(function (event) {
                    //阻止事件冒泡
                    event.stopPropagation();
                });
                $obli.eq(0).text(`确认使用${confrimText[0]}积分兑换`);
                $obli.eq(1).text(`${confrimText[1]}`);
                $obli.eq(2).text(`${confrimText[2]}`);
                $obli.eq(4).text(`优惠券有效期至${confrimText[3]}`);
                $obli.eq(5).find('a').click(function () {
                    confrimAjax(`${confrimText[4]}`,_finallyOption);
                });
                $ob.fadeIn(500);
                $ob.click(function () {
                    $(this).fadeOut(500);
                })
            }
            //确认 ajax
            function confrimAjax(_id, _finallyOption) {
                $.ajax({
                    type: "POST",
                    url: "{pigcms{:U('Voucher/ScoreGift_get_card')}",
                    data: {
                        id: _id
                    },
                    dataType: "json",
                    success: function (data) {
                        if (data.error == 0) {
                            alert(data.msg);
                            console.log(data);
                            //window.location.href = "{pigcms{:U('Voucher/voucher_list',array('type'=>1))}";
                        } else {
                            //返回错误
                            serverErrorDo(_finallyOption,data.msg);
                            // console.log(11);
                        }
                    },
                    error: function () {
                        //请求错误
                        serverErrorDo(_finallyOption,"服务器错误,请再次尝试");
                    }
                });
                return false;
            }
            //ajax 返回错误
            function serverErrorDo(_finallyOption, _errorMsg) {
                $(`#${_finallyOption.confrimId}`).fadeOut(1);
                let errorMg = _errorMsg ? _errorMsg : "出错啦";
                $(`#${_finallyOption.serverErrorId}`).find('p').last().text(`${errorMg}`);
                $(`#${_finallyOption.serverErrorId}`).fadeIn(500);
                $(`#${_finallyOption.serverErrorId}`).click(function () { 
                    $(this).fadeOut(500);
                });
            }
        }
    </script>

</body>

</html>